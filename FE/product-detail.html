<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookStore - Chi tiết sản phẩm</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Tùy chỉnh nhỏ */
        .product-card img {
            height: 300px;
            object-fit: cover;
        }

        .product-gallery-img {
            max-height: 500px;
            object-fit: contain;
        }
    </style>
</head>

<body>

    <!-- 1. Header (Navbar) - Lấy từ index.html -->
    <!-- 1. Header (Navbar) -->
    <div id="navbar-placeholder"></div>

    <!-- Nội dung chính -->
    <main class="container my-4" id="mainContent" style="display: none;">

        <!-- 1. Breadcrumb -->
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="index.html">Trang chủ</a></li>
                        <!-- [CSDL] Lấy từ Categories.name -->
                        <li class="breadcrumb-item"><a href="#" id="breadcrumbCategory">Danh mục</a></li>
                        <!-- [CSDL] Lấy từ Products.title -->
                        <li class="breadcrumb-item active" aria-current="page" id="breadcrumbTitle">Tên sách</li>
                    </ol>
                </nav>
            </div>
        </div>

        <!-- 2. Khu vực thông tin chính (Ảnh và Mua hàng) -->
        <section class="row g-4">
            <!-- Khu vực ảnh sản phẩm (Gallery) -->
            <div class="col-lg-5 col-md-6">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <!-- [CSDL] Lấy từ Products.image_url -->
                        <img src="" class="img-fluid rounded product-gallery-img" alt="Bìa sách chính"
                            id="productImage">
                    </div>
                </div>
            </div>

            <!-- Thông tin mua hàng -->
            <div class="col-lg-7 col-md-6">
                <!-- [CSDL] Lấy từ Products.title -->
                <h2 class="fw-bold" id="productTitle">Tên sách</h2>

                <!-- [CSDL] Lấy từ Authors.name -->
                <p class="text-muted fs-5 mb-2">Tác giả: <span id="productAuthor" class="fw-bold">...</span></p>
                <!-- [CSDL] Lấy từ Publishers.name -->
                <p class="text-muted fs-6 mb-3">Nhà xuất bản: <span id="productPublisher">...</span></p>

                <!-- [CSDL] Lấy từ Products.price -->
                <h3 class="text-danger fw-bolder mb-3" id="productPrice">0đ</h3>

                <!-- [CSDL] Kiểm tra Products.stock_quantity -->
                <div class="alert alert-success" role="alert" id="stockStatus">
                    <i class="fa-solid fa-check-circle me-2"></i>
                    <strong>Còn hàng</strong> (Còn <span id="stockQuantity">0</span> sản phẩm)
                </div>

                <!-- Chọn Số lượng -->
                <div class="mb-3">
                    <label for="quantityInput" class="form-label fw-bold">Số lượng:</label>
                    <div class="input-group" style="max-width: 150px;">
                        <button class="btn btn-outline-secondary" type="button"
                            onclick="this.nextElementSibling.stepDown()">-</button>
                        <input type="number" class="form-control text-center" id="quantityInput" value="1" min="1"
                            max="1"> <!-- max = stock_quantity -->
                        <button class="btn btn-outline-secondary" type="button"
                            onclick="this.previousElementSibling.stepUp()">+</button>
                    </div>
                </div>

                <!-- Nút bấm -->
                <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-lg" id="addToCartBtn">
                        <i class="fa-solid fa-cart-plus me-2"></i>
                        Thêm vào giỏ hàng
                    </button>
                    <!-- [CSDL] Nút này sẽ chuyển đến checkout.html, CẦN KIỂM TRA ĐĂNG NHẬP -->
                    <button class="btn btn-danger btn-lg" id="buyNowBtn">
                        <i class="fa-solid fa-dollar-sign me-2"></i>
                        Mua ngay
                    </button>
                </div>
            </div>
        </section>

        <!-- 3. Tab Mô tả, Thông số, Bình luận -->
        <section class="row mt-5">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="productTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="description-tab" data-bs-toggle="tab"
                                    data-bs-target="#description" type="button" role="tab" aria-controls="description"
                                    aria-selected="true">Mô Tả Sản Phẩm</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="specs-tab" data-bs-toggle="tab" data-bs-target="#specs"
                                    type="button" role="tab" aria-controls="specs" aria-selected="false">Thông Số Kỹ
                                    Thuật</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="comments-tab" data-bs-toggle="tab"
                                    data-bs-target="#comments" type="button" role="tab" aria-controls="comments"
                                    aria-selected="false">Bình Luận</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content p-3" id="productTabContent">
                            <!-- Tab Mô tả -->
                            <div class="tab-pane fade show active" id="description" role="tabpanel"
                                aria-labelledby="description-tab">
                                <h4 class="mb-3">Mô Tả Sản Phẩm</h4>
                                <!-- [CSDL] Lấy từ Products.description -->
                                <div id="productDescription"></div>
                            </div>
                            <!-- Tab Thông số -->
                            <div class="tab-pane fade" id="specs" role="tabpanel" aria-labelledby="specs-tab">
                                <h4 class="mb-3">Thông Số Kỹ Thuật</h4>
                                <table class="table table-striped table-bordered">
                                    <tbody>
                                        <tr>
                                            <th scope="row" style="width: 200px;">Tác giả</th>
                                            <!-- [CSDL] Lấy từ Authors.name -->
                                            <td id="specAuthor">...</td>
                                        </tr>
                                        <tr>
                                            <th scope="row">Nhà xuất bản</th>
                                            <!-- [CSDL] Lấy từ Publishers.name -->
                                            <td id="specPublisher">...</td>
                                        </tr>
                                        <tr>
                                            <th scope="row">Ngày sinh tác giả</th>
                                            <!-- [CSDL] Lấy từ Authors.year_of_birth -->
                                            <td id="specAuthorDob">...</td>
                                        </tr>
                                        <tr>
                                            <th scope="row">Quê quán</th>
                                            <!-- [CSDL] Lấy từ Authors.hometown -->
                                            <td id="specAuthorHometown">...</td>
                                        </tr>
                                        <tr>
                                            <th scope="row">Danh mục</th>
                                            <!-- [CSDL] Lấy từ Categories.name -->
                                            <td id="specCategory">...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- Tab Bình luận -->
                            <div class="tab-pane fade" id="comments" role="tabpanel" aria-labelledby="comments-tab">
                                <h4 class="mb-3">Bình Luận</h4>
                                <p class="text-muted">Tính năng bình luận đang được phát triển.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. Khu vực sản phẩm liên quan -->
        <section class="row mt-5">
            <div class="col-12">
                <h2 class="text-center mb-4">Sản Phẩm Liên Quan</h2>
                <!-- [CSDL] Lấy từ bảng Products (cùng Categories.id) -->
                <div id="relatedProducts" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
                    <!-- Related products will be populated here -->
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <div id="loadingSpinner" class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Đang tải thông tin sản phẩm...</p>
    </div>

    <div id="errorMessage" class="container my-5 text-center" style="display: none;">
        <h3 class="text-danger">Không tìm thấy sản phẩm</h3>
        <p>Sản phẩm bạn tìm kiếm không tồn tại hoặc đã bị xóa.</p>
        <a href="index.html" class="btn btn-primary">Về trang chủ</a>
    </div>

    <!-- 5. Footer - Lấy từ index.html -->
    <!-- 5. Footer -->
    <div id="footer-placeholder"></div>


    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="js/include.js"></script>
    <script src="js/config.js"></script>
    <script src="js/cart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            const mainContent = document.getElementById('mainContent');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const errorMessage = document.getElementById('errorMessage');

            if (!productId) {
                loadingSpinner.style.display = 'none';
                errorMessage.style.display = 'block';
                return;
            }

            try {
                // 1. Fetch Product Details
                const productResponse = await fetch(`${CONFIG.API_BASE_URL}/products/${productId}`);
                if (!productResponse.ok) throw new Error('Product not found');
                const product = await productResponse.json();

                // Update UI with Product Details
                document.title = `BookStore - ${product.title}`;
                document.getElementById('breadcrumbTitle').textContent = product.title;
                document.getElementById('productTitle').textContent = product.title;
                document.getElementById('productPrice').textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.price);
                document.getElementById('productImage').src = product.image_url || 'https://placehold.co/600x500/f8f9fa/6c757d?text=No+Image';
                document.getElementById('productDescription').innerHTML = product.description ? `<p>${product.description}</p>` : '<p>Chưa có mô tả.</p>';

                // Stock Logic
                const stockQuantity = document.getElementById('stockQuantity');
                const stockStatus = document.getElementById('stockStatus');
                const quantityInput = document.getElementById('quantityInput');
                const addToCartBtn = document.getElementById('addToCartBtn');

                stockQuantity.textContent = product.stock_quantity;
                quantityInput.max = product.stock_quantity;

                if (product.stock_quantity <= 0) {
                    stockStatus.className = 'alert alert-danger';
                    stockStatus.innerHTML = '<i class="fa-solid fa-times-circle me-2"></i><strong>Hết hàng</strong>';
                    quantityInput.disabled = true;
                    addToCartBtn.disabled = true;
                    addToCartBtn.textContent = 'Hết hàng';
                }

                // Add to Cart Logic
                addToCartBtn.addEventListener('click', () => {
                    const quantity = parseInt(quantityInput.value);
                    if (quantity > 0) {
                        Cart.add(product, quantity);
                        alert('Đã thêm sản phẩm vào giỏ hàng!');
                    }
                });

                // Buy Now Logic
                const buyNowBtn = document.getElementById('buyNowBtn');
                if (buyNowBtn) {
                    buyNowBtn.addEventListener('click', () => {
                        const quantity = parseInt(quantityInput.value);
                        if (quantity > 0) {
                            Cart.add(product, quantity);
                            window.location.href = 'checkout.html'; // Redirect to checkout (or cart first if preferred)
                        }
                    });
                }

                // 2. Fetch Additional Details (Category, Author, Publisher) in Parallel
                const fetchCategory = product.category_id ? fetch(`${CONFIG.API_BASE_URL}/products/categories/${product.category_id}`).then(res => res.ok ? res.json() : null) : Promise.resolve(null);
                const fetchAuthor = product.author_id ? fetch(`${CONFIG.API_BASE_URL}/products/authors/${product.author_id}`).then(res => res.ok ? res.json() : null) : Promise.resolve(null);
                const fetchPublisher = product.publisher_id ? fetch(`${CONFIG.API_BASE_URL}/products/publishers/${product.publisher_id}`).then(res => res.ok ? res.json() : null) : Promise.resolve(null);

                const [category, author, publisher] = await Promise.all([fetchCategory, fetchAuthor, fetchPublisher]);

                // Update UI with Additional Details
                if (category) {
                    const breadcrumbCategory = document.getElementById('breadcrumbCategory');
                    breadcrumbCategory.textContent = category.name;
                    breadcrumbCategory.href = `category.html?id=${category.id}`;
                    document.getElementById('specCategory').textContent = category.name;
                }

                if (author) {
                    document.getElementById('productAuthor').textContent = author.name;
                    document.getElementById('specAuthor').textContent = author.name;
                    document.getElementById('specAuthorDob').textContent = author.year_of_birth || 'N/A';
                    document.getElementById('specAuthorHometown').textContent = author.hometown || 'N/A';
                }

                if (publisher) {
                    document.getElementById('productPublisher').textContent = publisher.name;
                    document.getElementById('specPublisher').textContent = publisher.name;
                }

                // 3. Fetch Related Products (Same Category)
                if (product.category_id) {
                    fetchRelatedProducts(product.category_id, product.id);
                } else {
                    document.getElementById('relatedProducts').innerHTML = '<p class="text-center w-100">Không có sản phẩm liên quan.</p>';
                }

                // Show Content
                loadingSpinner.style.display = 'none';
                mainContent.style.display = 'block';

            } catch (error) {
                console.error('Error loading product:', error);
                loadingSpinner.style.display = 'none';
                errorMessage.style.display = 'block';
            }
        });

        async function fetchRelatedProducts(categoryId, currentProductId) {
            const container = document.getElementById('relatedProducts');
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/products/?category_id=${categoryId}&limit=4`);
                if (response.ok) {
                    let products = await response.json();
                    // Filter out current product
                    products = products.filter(p => p.id !== currentProductId).slice(0, 4);

                    container.innerHTML = '';
                    if (products.length === 0) {
                        container.innerHTML = '<p class="text-center w-100">Không có sản phẩm liên quan.</p>';
                        return;
                    }

                    products.forEach(product => {
                        const productCard = `
                            <div class="col">
                                <div class="card h-100 shadow-sm product-card">
                                    <img src="${product.image_url || 'https://placehold.co/300x400?text=No+Image'}" class="card-img-top" alt="${product.title}">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title text-truncate" title="${product.title}">${product.title}</h5>
                                        <h6 class="card-subtitle mb-2 text-danger mt-auto pt-2">${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.price)}</h6>
                                        <a href="product-detail.html?id=${product.id}" class="btn btn-primary mt-2">Xem chi tiết</a>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', productCard);
                    });
                }
            } catch (error) {
                console.error('Error loading related products:', error);
                container.innerHTML = '<p class="text-danger text-center w-100">Lỗi tải sản phẩm liên quan.</p>';
            }
        }
    </script>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>